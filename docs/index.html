<!doctype html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, height=device-height, minimum-scale=1, maximum-scale=1, initial-scale=1, user-scalable=no">
        <meta name="referrer" content="no-referrer">

        <link rel="icon" href="./favicon.ico">

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vuetify@2/dist/vuetify.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@5/css/materialdesignicons.min.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c&family=Kosugi+Maru">

        <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/vuetify@2/dist/vuetify.min.js"></script>

        <title>FF14 闇ツール</title>
    </head>

    <body>
        <template id="vue">
            <v-app>
                <v-snackbar dark top centered :color="notify.color" v-model="notify.visible">
                    <v-icon left>mdi-bell-ring-outline</v-icon>
                    <span>{{notify.message}}</span>
                    <template #action>
                        <v-btn icon @click="notify.visible = false">
                            <v-icon>mdi-close</v-icon>
                        </v-btn>
                    </template>
                </v-snackbar>

                <v-overlay dark z-index="9" opacity="0.9" v-model="loading.visible">
                    <v-progress-circular indeterminate size="128" width="6" color="blue lighten-2">
                        <span class="white--text">Loading...</span>
                    </v-progress-circular>
                </v-overlay>

                <v-app-bar app dark color="pink lighten-3" height="52">
                    <v-toolbar-title class="pl-1">ふ～ん。で、エタバンしてるの？</v-toolbar-title>
                </v-app-bar>

                <v-main>
                    <v-window touchless class="fill-height" v-model="router.path">
                        <v-window-item value="/" transition="fade-transition">
                            <v-card flat>
                                <v-card-title class="justify-center">気になるあの子の名前を入れてみよう...!!</v-card-title>
                            </v-card>

                            <v-row no-gutters justify="center">
                                <v-col cols sm="6" md="4" lg="2" xl="1">
                                    <v-card flat>
                                        <v-card-text>
                                            <v-text-field clearable prepend-icon="mdi-alphabetical-variant" label="キャラクター名" v-model="search.name"></v-text-field>
                                            <v-autocomplete clearable prepend-icon="mdi-web" label="ワールド" :items="servers" v-model="search.server"></v-autocomplete>
                                        </v-card-text>

                                        <v-card-text class="text-center pa-0">または</v-card-text>

                                        <v-card-text>
                                            <v-text-field clearable prepend-icon="mdi-numeric" type="number" label="Lodestone ID" v-model="search.id"></v-text-field>
                                        </v-card-text>

                                        <v-card-actions>
                                            <v-btn dark block color="blue lighten-2" @click="doSearch()">
                                                <span>検索</span>
                                                <v-icon right>mdi-account-search-outline</v-icon>
                                            </v-btn>
                                        </v-card-actions>
                                    </v-card>
                                </v-col>
                            </v-row>
                        </v-window-item>

                        <v-window-item value="/candidates" transition="fade-transition">
                            <v-container fluid>
                                <v-card flat>
                                    <v-card-actions class="justify-center">
                                        <v-btn text tile @click="backHome(false)">
                                            <v-icon left>mdi-arrow-left</v-icon>
                                            <span>検索をやり直す</span>
                                        </v-btn>
                                    </v-card-actions>
                                </v-card>

                                <v-list>
                                    <v-subheader>検索結果: {{candidates.length}} 件</v-subheader>
                                    <template v-for="candidate in candidates">
                                        <v-list-item :key="candidate.ID" @click="getCharacter(candidate.ID)">
                                            <v-list-item-avatar size="48">
                                                <v-img :src="candidate.Avatar"></v-img>
                                            </v-list-item-avatar>

                                            <v-list-item-content>
                                                <v-list-item-title>{{candidate.Name}}</v-list-item-title>
                                                <v-list-item-subtitle>ID: {{candidate.ID}}</v-list-item-subtitle>
                                                <v-list-item-subtitle>Server: {{candidate.Server}}</v-list-item-subtitle>
                                            </v-list-item-content>
                                        </v-list-item>
                                    </template>
                                </v-list>
                            </v-container>
                        </v-window-item>

                        <v-window-item value="/character" transition="fade-transition">
                            <v-card flat>
                                <v-card-actions class="justify-center">
                                    <v-btn text tile @click="backHome(true)">
                                        <v-icon left>mdi-reload</v-icon>
                                        <span>最初からやり直す</span>
                                    </v-btn>
                                </v-card-actions>
                            </v-card>

                            <v-row no-gutters justify="center">
                                <v-col cols sm="10" md="6" lg="4" xl="2">
                                    <v-card flat>
                                        <v-card-title>{{character.name}}</v-card-title>
                                        <v-card-subtitle>
                                            ID: <a :href="`https://jp.finalfantasyxiv.com/lodestone/character/${character.id}`" target="_blank" rel="noopener">{{character.id}}</a>
                                            <br>
                                            Server: {{character.server}}
                                        </v-card-subtitle>

                                        <v-card-text class="py-0">さんはエターナルバンドを...</v-card-text>

                                        <template v-if="character.marry && character.ring">
                                            <v-card-title>している可能性が高いです。</v-card-title>

                                            <v-card-text>
                                                残念... 無理に迫らず潔く諦めて自分磨きに精進しましょう。
                                            </v-card-text>

                                            <v-card-text>
                                                Note: 所持マウントからエターナルチョコボを検出しました
                                                <br>
                                                Note: 装備品/武具投影からエターナルリングを検出しました
                                            </v-card-text>
                                        </template>

                                        <template v-else-if="character.marry">
                                            <v-card-title>している可能性があります。</v-card-title>

                                            <v-card-text>
                                                継続中なら残念... 無理に迫らず潔く諦めて自分磨きに精進しましょう。
                                                <br>
                                                解消済ならチャンス! あなたの立ち回り次第で可能性は無限大です。
                                            </v-card-text>

                                            <v-card-text>
                                                Note: 所持マウントからエターナルチョコボを検出しました
                                            </v-card-text>
                                        </template>

                                        <template v-else>
                                            <v-card-title>していない可能性が高いです。</v-card-title>

                                            <v-card-text>
                                                チャンス! あなたの立ち回り次第で可能性は無限大です。
                                                <br>
                                                サブキャラでないことを祈ります...
                                                <br>
                                                (エターナルチョコボを入手できない無料プランでしている可能性もあります)
                                            </v-card-text>
                                        </template>

                                        <v-card-text>
                                            <v-img :src="character.picture"></v-img>
                                        </v-card-text>
                                    </v-card>
                                </v-col>
                            </v-row>
                        </v-window-item>
                    </v-window>
                </v-main>

                <v-footer dark padless color="pink lighten-3">
                    <v-container fluid class="pa-0">
                        <v-row no-gutters justify="center">
                            <v-btn text tile block href="https://github.com/dojyorin/ffxiv-areyoumarried" target="_blank" rel="noopener">
                                <v-icon left>mdi-github</v-icon>
                                <span>GitHub Repository</span>
                            </v-btn>
                        </v-row>

                        <v-row no-gutters justify="center">
                            <span class="text-caption">Powered by XIVAPI.</span>
                        </v-row>

                        <v-row no-gutters justify="center">
                            <span class="text-caption">Copyright SQUARE ENIX CO., LTD. All Rights Reserved.</span>
                        </v-row>
                    </v-container>
                </v-footer>
            </v-app>
        </template>
    </body>

    <script async type="module">
        async function $fetch(path, option){
            const {origin, pathname} = /^https*:\/\//i.test(path) ? new URL(path) : new URL(path, location.href);
            const query = new URLSearchParams(Object.entries(option?.query ?? {})).toString();

            const response = await fetch(`${origin}${pathname === "/" ? "": pathname}${query === "" ? "" : `?${query}`}`.toLowerCase(), {
                method: option?.method ?? "get",
                credentials: option?.credentials ?? "omit",
                mode: option?.mode ?? "cors",
                cache: option?.cache ?? "no-cache",
                referrerPolicy: option?.referrerPolicy ?? "no-referrer",
                referrer: option?.referrer ?? "",
                redirect: option?.redirect ?? "follow",
                keepalive: option?.keepalive ?? false,
                integrity: "",
                signal: null,
                window: null,
                headers: option?.headers ?? {},
                body: option?.body ?? null
            });

            return option?.type === "raw" ? response : response[option?.type ?? "json"]();
        }

        const vue = new Vue({
            el: "#vue",
            vuetify: new Vuetify(),

            data(){
                return {
                    notify: {
                        visible: false,
                        message: "",
                        color: ""
                    },
                    loading: {
                        visible: false
                    },
                    router: {
                        path: "/"
                    },
                    servers: [],
                    candidates: [],
                    search: {
                        name: "",
                        server: "",
                        id: ""
                    },
                    character: {
                        name: "",
                        id: 0,
                        server: "",
                        picture: "",
                        marry: false,
                        ring: false
                    }
                };
            },

            methods: {
                vNotify(message, color){
                    this.notify.visible = false;
                    this.notify.message = message ?? "";
                    this.notify.color = color ?? "info";
                    this.notify.visible = true;
                },

                vLoading(state){
                    this.loading.visible = state ?? false;
                },

                vRouter(path){
                    this.router.path = path ?? "/";
                },

                backHome(reset){
                    if(reset){
                        Object.assign(this.$data.search, this.$options.data().search);
                    }

                    Object.assign(this.$data.character, this.$options.data().character);

                    this.vRouter("/");

                    this.candidates.splice(0);
                },

                async doSearch(){
                    if(this.search.id){
                        await this.getCharacter(this.search.id);
                    }
                    else if(this.search.name){
                        await this.getCharacterList(this.search.name, this.search.server);
                    }
                    else{
                        this.vNotify("検索ワードを入力してください", "error");
                    }
                },

                async getCharacterList(name, server){
                    this.vLoading(true);

                    try{
                        const {Results} = await $fetch("https://xivapi.com/character/search", {
                            query: {
                                name: name.trim().split(/\s/).join("+"),
                                server: server
                            }
                        });

                        if(!Results.length){
                            throw "Results not found.";
                        }
                        else if(Results.length === 50){
                            this.vNotify("検索結果が多すぎるため、上位50件のみ取得されました");
                        }

                        for(const candidate of Results){
                            this.candidates.push(candidate);
                        }

                        this.vRouter("/candidates");
                    }
                    catch{
                        this.backHome(true);
                        this.vNotify("検索結果が見つかりませんでした", "error");
                    }
                    finally{
                        this.vLoading(false);
                    }
                },

                async getCharacter(id){
                    this.vLoading(true);

                    try{
                        const {Character, Mounts} = await $fetch(`https://xivapi.com/character/${id}`, {
                            query: {
                                data: "MIMO",
                                extended: 1
                            }
                        });

                        this.character.name = Character.Name;
                        this.character.id = Character.ID;
                        this.character.server = `${Character.Server} (${Character.DC})`;
                        this.character.picture = Character.Portrait;
                        this.character.marry = Mounts?.some(({Name}) => Name === "Ceremony Chocobo") ?? false;
                        this.character.ring = [
                            Character.GearSet.Gear.Ring1?.Mirage?.ID,
                            Character.GearSet.Gear.Ring2?.Mirage?.ID,
                            Character.GearSet.Gear.Ring1?.Item?.ID,
                            Character.GearSet.Gear.Ring2?.Item?.ID
                        ].some(ring => ring === 8575);

                        this.vRouter("/character");
                    }
                    catch{
                        this.backHome(true);
                        this.vNotify("検索結果が見つかりませんでした", "error");
                    }
                    finally{
                        this.vLoading(false);
                    }
                }
            },

            async mounted(){
                this.vLoading(true);

                for(const server of await $fetch("https://xivapi.com/servers")){
                    this.servers.push(server);
                }

                this.vLoading(false);
            }
        });
    </script>

    <style>
        ::-webkit-scrollbar{
            display: none !important;
        }
        .v-application{
            font-family: "M PLUS Rounded 1c", "Kosugi Maru" !important;
        }
        .v-btn{
            text-transform: none !important;
            letter-spacing: normal !important;
            text-indent: 0 !important;
        }
    </style>
</html>